---
title: PostgreSQL from Lisp
tags: [lisp]
layout: post
---

<p>Hello everybody,
</p>
<p>
It has been a long time before my last post. Many things happened: I
had a great time in <a href="http://weitz.de/eclm2013/">ECL2013</a>, I <a href="https://github.com/davazp/jscl/blob/master/src/compiler/codegen.lisp">wrote a code generator for JSCL</a>, exams
in the university&hellip; and suffering the heat at home in Spain, of
course.
</p>
<p>
These days, at work, I am migrating our old SQL Server to PostgreSQL.
We used to use CLSQL to access to the server from Lisp-side, but in a
very straightforward way. We built everything on <code>query</code>. Although
CLSQL is a big monster, it misses parametric queries, and you have to
escape arguments yourself. Indeed, it was not as much stable as I
would like. But let apart exotic features.
</p>
<p>
Therefore I gave a try to other libraries. The obvious choice would be
<a href="http://marijnhaverbeke.nl/postmodern/">Postmodern</a>, but it failed soon. DAO capabilities seem incomplete and,
I think, they should be other library, but I can live ignoring
it. However, have a look to <a href="http://marijnhaverbeke.nl/postmodern/postmodern.html#query">query</a>: it has a strange arg/format mix and
it is a macro! It means you will fail to build simple abstractions on
it.
</p>
<p>
Fortunately, Postmodern's author created a lower library <a href="http://marijnhaverbeke.nl/postmodern/cl-postgres.html">cl-postgres</a>,
which I can suit easily:
</p>



<pre class="src src-lisp"><span style="color: #696969;">(</span><span style="color: #DEC77B;">defun</span> <span style="color: #D65921;">query</span> <span style="color: #696969;">(</span>query <span style="color: #607060; text-decoration: underline;">&amp;rest</span> args<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cl-postgres:prepare-query *database* <span style="color: #8CBED6;">""</span> query<span style="color: #696969;">)</span>
  <span style="color: #696969;">(</span>cl-postgres:exec-prepared *database* <span style="color: #8CBED6;">""</span> args 'cl-postgres:list-row-reader<span style="color: #696969;">))</span>
</pre>


<p>
but of course I will have to write connection pooling and other
features myself, or perhaps mix postmodern and cl-postgres carefully.
</p>
<p>
In conclusion, I think we should be a little bit more <i>conventional</i>
in the abstractions we build, and not to forget intermediate
abstractions.
</p>
